<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Piano Inventory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- HEIC to JPG conversion library -->
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; color:#333; }
    h1 { margin-bottom: 15px; }
    #controls { margin-bottom: 20px; }
    #controls button { margin-right: 10px; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; }
    #controls input { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
    .card { background: #fff; border-radius: 10px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .card img { border-radius: 6px; }
    .card h3 { margin: 6px 0; }
    .card .meta { font-size: 0.9em; color: #555; margin-bottom: 6px; }
    .actions button { margin-right: 5px; margin-top: 5px; padding: 5px 8px; font-size: 0.85em; border-radius: 5px; cursor: pointer; border:none; }
    .blue { background:#3498db; color:#fff; }
    .green { background:#2ecc71; color:#fff; }
    .red { background:#e74c3c; color:#fff; }
    .orange { background:#f39c12; color:#fff; }
    .gray { background:#7f8c8d; color:#fff; }
    dialog { border: none; border-radius: 10px; padding: 20px; max-width: 500px; width: 90%; }
    dialog::backdrop { background: rgba(0,0,0,0.4); }
    form label { display: block; margin-top: 10px; font-weight: bold; }
    form input, form select, form textarea { width: 100%; padding: 6px; margin-top: 3px; border-radius: 6px; border: 1px solid #ccc; }
    form textarea { resize: vertical; }
    .preview-img { max-width: 100%; margin-top: 10px; border-radius: 6px; }
    #imgPreview { cursor:pointer; }
  </style>
</head>
<body>
  <h1>ðŸŽ¹ Piano Inventory</h1>
  <div id="controls">
    <button onclick="openAddModal()">âž• Add Piano</button>
    <input type="text" id="search" placeholder="Search by brand, model, serial, notes...">
  </div>

  <div class="grid" id="pianoGrid"></div>

  <!-- Add/Edit Modal -->
  <dialog id="pianoModal">
    <form method="dialog" id="pianoForm">
      <input type="hidden" id="pianoId">
      <label>Brand <input id="brand"></label>
      <label>Model <input id="model"></label>
      <label>Serial Number <input id="serialNumber"></label>
      <label>Year <input id="year" type="number"></label>
      <label>Color <input id="color"></label>
      <label>Location <input id="location"></label>
      <label>Delivered <input id="delivered"></label>
      <label>Player System 
        <select id="playerSystem">
          <option value="">-- Select --</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </label>
      <label>Status 
        <select id="status">
          <option value="active">Active</option>
          <option value="sold">Sold</option>
          <option value="archive">Archived</option>
        </select>
      </label>
      <label>Notes <textarea id="notes"></textarea></label>
      <label>Photo <input type="file" id="photoInput" accept="image/*,.heic"></label>
      <img id="imgPreview" class="preview-img" style="display:none" onclick="openPreview(this.src)">
      <menu>
        <button value="cancel">Cancel</button>
        <button id="saveBtn" value="default">Save</button>
      </menu>
    </form>
  </dialog>

  <!-- Image Preview -->
  <dialog id="imgDialog">
    <img id="imgDialogContent" style="max-width:90vw; max-height:80vh; border-radius:8px;">
  </dialog>

  <script>
    const grid=document.getElementById("pianoGrid");
    const modal=document.getElementById("pianoModal");
    const form=document.getElementById("pianoForm");
    const imgPreview=document.getElementById("imgPreview");
    const photoInput=document.getElementById("photoInput");
    const imgDialog=document.getElementById("imgDialog");
    const imgDialogContent=document.getElementById("imgDialogContent");

    let pianos=JSON.parse(localStorage.getItem("pianos")||"[]");

    function saveData(){ localStorage.setItem("pianos", JSON.stringify(pianos)); }
    function openPreview(src){ imgDialogContent.src=src; imgDialog.showModal(); }
    function openAddModal(){ form.reset(); document.getElementById("pianoId").value=""; imgPreview.style.display="none"; modal.showModal(); }

    function render(){
      grid.innerHTML="";
      const q=document.getElementById("search").value.toLowerCase();
      const filtered=pianos.filter(p=>
        (p.brand||"").toLowerCase().includes(q) ||
        (p.model||"").toLowerCase().includes(q) ||
        (p.serialNumber||"").toLowerCase().includes(q) ||  // âœ… search by serial number
        (p.notes||"").toLowerCase().includes(q)
      );
      for(const d of filtered){
        const c=document.createElement("div");
        c.className="card";
        const extra=`${d.delivered?`<div class="meta">Delivered: ${d.delivered}</div>`:""}
                     ${d.playerSystem?`<div class="meta">Player System: ${d.playerSystem}</div>`:""}`;
        c.innerHTML=`
          ${d.photoURL?`<div><img src="${d.photoURL}" alt="photo" style="width:100%; max-height:180px; object-fit:cover; border-radius:6px; margin-bottom:8px; cursor:pointer;" onclick="openPreview('${d.photoURL}')"></div>`:""}
          <h3>${(d.brand||"")+(d.model?" "+d.model:"")}</h3>
          <div class="meta">
            Status: ${d.status||"active"}
            ${d.year?" â€¢ Year "+d.year:""}
            ${d.color?" â€¢ "+d.color:""}
            ${d.location?" â€¢ "+d.location:""}
            ${d.serialNumber?` â€¢ SN: ${d.serialNumber}`:""}
          </div>
          ${d.notes?`<div class="meta">${d.notes}</div>`:""}
          ${extra}
          <div class="actions">
            <button class="blue" onclick="updateStatus('${d._id}','sold')">Sell</button>
            <button class="gray" onclick="updateStatus('${d._id}','archive')">Archive</button>
            <button class="green" onclick="updateStatus('${d._id}','active')">Activate</button>
            <button class="orange" onclick="editPiano('${d._id}')">Edit</button>
            <button class="red" onclick="deletePiano('${d._id}')">Delete</button>
          </div>
        `;
        grid.appendChild(c);
      }
    }

    function editPiano(id){
      const p=pianos.find(x=>x._id===id);
      if(!p) return;
      document.getElementById("pianoId").value=p._id;
      document.getElementById("brand").value=p.brand||"";
      document.getElementById("model").value=p.model||"";
      document.getElementById("serialNumber").value=p.serialNumber||"";
      document.getElementById("year").value=p.year||"";
      document.getElementById("color").value=p.color||"";
      document.getElementById("location").value=p.location||"";
      document.getElementById("delivered").value=p.delivered||"";
      document.getElementById("playerSystem").value=p.playerSystem||"";
      document.getElementById("status").value=p.status||"active";
      document.getElementById("notes").value=p.notes||"";
      if(p.photoURL){ imgPreview.src=p.photoURL; imgPreview.style.display="block"; } else { imgPreview.style.display="none"; }
      modal.showModal();
    }

    function deletePiano(id){
      if(confirm("Delete this piano?")){
        pianos=pianos.filter(x=>x._id!==id);
        saveData(); render();
      }
    }

    function updateStatus(id,status){
      const p=pianos.find(x=>x._id===id);
      if(p){ p.status=status; saveData(); render(); }
    }

    form.onsubmit=async e=>{
      e.preventDefault();
      const id=document.getElementById("pianoId").value || Date.now().toString();
      const data={
        _id:id,
        brand:document.getElementById("brand").value,
        model:document.getElementById("model").value,
        serialNumber:document.getElementById("serialNumber").value,
        year:document.getElementById("year").value,
        color:document.getElementById("color").value,
        location:document.getElementById("location").value,
        delivered:document.getElementById("delivered").value,
        playerSystem:document.getElementById("playerSystem").value,
        status:document.getElementById("status").value,
        notes:document.getElementById("notes").value,
      };

      // Handle photo
      if(photoInput.files[0]){
        let file=photoInput.files[0];
        if(file.name.toLowerCase().endsWith(".heic")){
          const conv=await heic2any({blob:file, toType:"image/jpeg"});
          file=new File([conv],"converted.jpg",{type:"image/jpeg"});
        }
        const reader=new FileReader();
        reader.onload=e2=>{
          data.photoURL=e2.target.result;
          finishSave(data,id);
        };
        reader.readAsDataURL(file);
      } else {
        const ex=pianos.find(x=>x._id===id);
        if(ex && ex.photoURL) data.photoURL=ex.photoURL;
        finishSave(data,id);
      }
    };

    function finishSave(data,id){
      const idx=pianos.findIndex(x=>x._id===id);
      if(idx>=0) pianos[idx]=data; else pianos.push(data);
      saveData(); render(); modal.close();
    }

    document.getElementById("search").oninput=render;
    photoInput.onchange=()=>{
      if(photoInput.files[0]){
        const reader=new FileReader();
        reader.onload=e=>{ imgPreview.src=e.target.result; imgPreview.style.display="block"; };
        reader.readAsDataURL(photoInput.files[0]);
      }
    };

    render();
  </script>
</body>
</html>
