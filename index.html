<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Piano Inventory</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; }
    h1 { color:#333; }
    input, select, button { margin:5px; padding:8px; }
    ul { list-style:none; padding:0; }
    li { margin:10px 0; padding:10px; border:1px solid #ccc; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
    .btn-group button { margin-left:5px; }
    .auth { margin-bottom:20px; }
    img { max-width:80px; max-height:80px; margin-right:10px; border-radius:4px; }
    #dropZone { border:2px dashed #aaa; padding:10px; margin:5px 0; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Piano Inventory</h1>

  <!-- Auth -->
  <div class="auth">
    <h2 id="authHeader">Admin Login</h2>
    <div id="loginForm">
      <input id="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <button id="loginBtn">Login</button>
    </div>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>

  <!-- Controls (only visible when logged in) -->
  <div id="controls" style="display:none;">
    <input id="brand" placeholder="Brand">
    <input id="model" placeholder="Model">
    <input id="serial" placeholder="Serial">
    <input id="price" placeholder="Price">
    <input id="qty" type="number" placeholder="Quantity" value="1" min="1">
    <select id="status">
      <option>On Floor</option>
      <option>In Storage</option>
      <option>Sold</option>
      <option>Detailed</option>
      <option>Potential Buyer</option>
    </select>
    <div id="dropZone">Drag & drop photo here, or click to select</div>
    <input type="file" id="photoInput" accept="image/*" style="display:none;">
    <button id="addBtn">Add Piano</button>
  </div>

  <!-- Inventory List -->
  <h2>Current Inventory</h2>
  <ul id="inventoryList"></ul>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

    // ✅ Your Firebase config (fixed bucket)
    const firebaseConfig = {
      apiKey: "AIzaSyA2932IBDCeUix6OdRaJMDIisHX0SbyDFo",
      authDomain: "pianoinv.firebaseapp.com",
      projectId: "pianoinv",
      storageBucket: "pianoinv.appspot.com",   // ✅ FIXED
      messagingSenderId: "651707888262",
      appId: "1:651707888262:web:23131a782e31a7bb511707",
      measurementId: "G-1XQLEV28JZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const loginForm = document.getElementById("loginForm");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const controlsDiv = document.getElementById("controls");
    const addBtn = document.getElementById("addBtn");
    const inventoryList = document.getElementById("inventoryList");

    const brandInput = document.getElementById("brand");
    const modelInput = document.getElementById("model");
    const serialInput = document.getElementById("serial");
    const priceInput = document.getElementById("price");
    const qtyInput = document.getElementById("qty");
    const statusInput = document.getElementById("status");

    let droppedFile = null;

    // --- Auth ---
    loginBtn.addEventListener("click", async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert(err.message);
      }
    });

    document.getElementById("password").addEventListener("keypress", (e) => {
      if (e.key === "Enter") loginBtn.click();
    });

    logoutBtn.addEventListener("click", () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginForm.style.display = "none";
        logoutBtn.style.display = "inline-block";
        controlsDiv.style.display = "flex";
      } else {
        loginForm.style.display = "block";
        logoutBtn.style.display = "none";
        controlsDiv.style.display = "none";
      }
    });

    // --- File Upload Handling ---
    const dropZone = document.getElementById("dropZone");
    const photoInput = document.getElementById("photoInput");

    dropZone.addEventListener("click", () => photoInput.click());
    dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.style.borderColor = "blue"; });
    dropZone.addEventListener("dragleave", () => { dropZone.style.borderColor = "#aaa"; });
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      droppedFile = e.dataTransfer.files[0];
      dropZone.textContent = "Selected: " + droppedFile.name;
      dropZone.style.borderColor = "green";
    });

    photoInput.addEventListener("change", (e) => {
      droppedFile = e.target.files[0];
      dropZone.textContent = "Selected: " + droppedFile.name;
      dropZone.style.borderColor = "green";
    });

    async function uploadPhoto(file) {
      const fileRef = ref(storage, 'piano_photos/' + Date.now() + '_' + file.name);
      await uploadBytes(fileRef, file);
      return await getDownloadURL(fileRef);
    }

    // --- Add Piano ---
    async function addPiano() {
      console.log("Add button clicked");
      if (!brandInput.value || !modelInput.value) {
        alert("Enter brand and model");
        return;
      }

      try {
        let photoURL = "";
        if (droppedFile) {
          console.log("Uploading photo:", droppedFile.name);
          photoURL = await uploadPhoto(droppedFile);
        }

        await addDoc(collection(db, "pianos"), {
          brand: brandInput.value,
          model: modelInput.value,
          serial: serialInput.value,
          price: priceInput.value,
          quantity: qtyInput.value,
          status: statusInput.value,
          photo: photoURL
        });

        console.log("Piano added successfully!");
        clearInputs();
      } catch (err) {
        console.error("Error adding piano:", err);
        alert("Error: " + err.message);
      }
    }

    addBtn.addEventListener("click", addPiano);

    function clearInputs() {
      brandInput.value = "";
      modelInput.value = "";
      serialInput.value = "";
      priceInput.value = "";
      qtyInput.value = "1";
      statusInput.value = "On Floor";
      droppedFile = null;
      dropZone.textContent = "Drag & drop photo here, or click to select";
      dropZone.style.borderColor = "#aaa";
    }

    // --- Render List ---
    function renderList(pianos) {
      inventoryList.innerHTML = "";
      pianos.forEach(p => {
        const li = document.createElement("li");
        li.innerHTML = `
          <div style="display:flex;align-items:center;">
            ${p.photo ? `<a href="${p.photo}" target="_blank"><img src="${p.photo}" alt="Piano"></a>` : ""}
            <div>
              <strong>${p.brand}</strong> - ${p.model} 
              | Serial: ${p.serial || "N/A"} 
              | Price: $${p.price || "N/A"} 
              | Qty: ${p.quantity || 0} 
              | Status: ${p.status || "N/A"}
            </div>
          </div>
          <div class="btn-group">
            <button onclick="deletePiano('${p.id}')" style="background:red;">Delete</button>
          </div>
        `;
        inventoryList.appendChild(li);
      });
    }

    // --- Real-time Sync ---
    onSnapshot(collection(db, "pianos"), (snapshot) => {
      const pianos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderList(pianos);
    });

    // --- Delete Piano ---
    window.deletePiano = async (id) => {
      await deleteDoc(doc(db, "pianos", id));
    };
  </script>
</body>
</html>
