<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Piano Inventory</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    .tabs { display: flex; justify-content: center; margin-bottom: 20px; }
    .tab { padding: 10px 20px; margin: 0 5px; border: 1px solid #ccc; cursor: pointer; background: #eee; border-radius: 5px; }
    .tab.active { background: #ddd; font-weight: bold; }
    .form-container { display: none; margin: 20px auto; padding: 20px; background: white; border-radius: 10px; max-width: 500px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .form-container.active { display: block; }
    .form-container input, .form-container select, .form-container textarea, .form-container button {
      width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc;
    }
    .inventory { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
    .piano-card { display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 10px; padding: 15px; width: 500px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .piano-details { flex: 1; }
    .piano-photo { width: 150px; height: 100px; object-fit: cover; border-radius: 8px; margin-left: 15px; }
    .actions button { margin-right: 5px; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; }
    .add-btn { background: green; color: white; }
    .delete-btn { background: red; color: white; }
    .sell-btn { background: blue; color: white; }
    .move-btn { background: orange; color: white; }
    progress { width: 100%; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Piano Inventory</h1>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="showTab('active')">Active</div>
    <div class="tab" onclick="showTab('archive')">Archive</div>
    <div class="tab" onclick="showTab('form')">Add Piano</div>
  </div>

  <!-- Add Piano Form -->
  <div id="form" class="form-container">
    <h2>Add Piano</h2>
    <input type="text" id="brand" placeholder="Brand" required>
    <input type="text" id="model" placeholder="Model" required>
    <input type="number" id="year" placeholder="Model Year">
    <input type="text" id="color" placeholder="Color">
    <input type="text" id="length" placeholder="Length">
    <select id="location">
      <option value="Gallery">Gallery</option>
      <option value="Cartersville">Cartersville</option>
    </select>
    <label><input type="checkbox" id="detailed"> Detailed</label>
    <input type="date" id="detailDate">
    <textarea id="notes" placeholder="Notes"></textarea>
    <input type="file" id="photo" accept="image/*">
    <progress id="uploadProgress" value="0" max="100" style="display:none;"></progress>
    <button class="add-btn" id="addPianoBtn">Add Piano</button>
  </div>

  <!-- Active Inventory -->
  <div id="active" class="inventory"></div>

  <!-- Archive -->
  <div id="archive" class="inventory" style="display:none;"></div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA2932IBDCeUix6OdRaJMDIisHX0SbyDFo",
      authDomain: "pianoinv.firebaseapp.com",
      projectId: "pianoinv",
      storageBucket: "pianoinv.firebasestorage.app",
      messagingSenderId: "651707888262",
      appId: "1:651707888262:web:23131a782e31a7bb511707",
      measurementId: "G-1XQLEV28JZ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Switch tabs
    function showTab(tabId) {
      document.querySelectorAll('.form-container, .inventory').forEach(el => el.style.display = 'none');
      document.getElementById(tabId).style.display = 'block';
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
    }

    const activeDiv = document.getElementById("active");
    const archiveDiv = document.getElementById("archive");
    const addBtn = document.getElementById("addPianoBtn");
    const progressBar = document.getElementById("uploadProgress");

    // Add piano
    addBtn.addEventListener("click", async () => {
      addBtn.disabled = true;
      const brand = document.getElementById("brand").value;
      const model = document.getElementById("model").value;
      const year = document.getElementById("year").value;
      const color = document.getElementById("color").value;
      const length = document.getElementById("length").value;
      const location = document.getElementById("location").value;
      const detailed = document.getElementById("detailed").checked;
      const detailDate = document.getElementById("detailDate").value;
      const notes = document.getElementById("notes").value;
      const file = document.getElementById("photo").files[0];

      let photoURL = "";
      if (file) {
        const storageRef = storage.ref("pianos/" + Date.now() + "_" + file.name);
        const uploadTask = storageRef.put(file);

        progressBar.style.display = "block";

        await new Promise((resolve, reject) => {
          uploadTask.on("state_changed", 
            (snapshot) => {
              const percent = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              progressBar.value = percent;
            }, 
            (error) => reject(error), 
            async () => {
              photoURL = await uploadTask.snapshot.ref.getDownloadURL();
              resolve();
            }
          );
        });
      }

      await db.collection("pianos").add({
        brand, model, year, color, length, location, detailed, detailDate, notes, photoURL,
        status: "active",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      addBtn.disabled = false;
      progressBar.style.display = "none";
      document.querySelectorAll("#form input, #form textarea, #form select").forEach(el => el.value = "");
      document.getElementById("detailed").checked = false;
      showTab("active");
    });

    // Render piano card
    function renderPiano(doc, container, isArchive = false) {
      const data = doc.data();
      const div = document.createElement("div");
      div.classList.add("piano-card");

      div.innerHTML = `
        <div class="piano-details">
          <strong>${data.brand} ${data.model}</strong><br>
          Year: ${data.year || "-"} | Color: ${data.color || "-"} | Length: ${data.length || "-"}<br>
          Location: ${data.location || "-"}<br>
          Detailed: ${data.detailed ? "Yes (" + (data.detailDate || "N/A") + ")" : "No"}<br>
          Notes: ${data.notes || ""}
          <div class="actions">
            ${!isArchive 
              ? `<button class="sell-btn" onclick="moveToArchive('${doc.id}')">Sell</button>
                 <button class="delete-btn" onclick="deletePiano('${doc.id}')">Delete</button>`
              : `<button class="move-btn" onclick="moveToActive('${doc.id}')">Move Back</button>
                 <button class="delete-btn" onclick="deletePiano('${doc.id}')">Delete</button>`}
          </div>
        </div>
        ${data.photoURL ? `<img src="${data.photoURL}" class="piano-photo">` : ""}
      `;
      container.appendChild(div);
    }

    // Firestore listeners
    db.collection("pianos").where("status", "==", "active")
      .orderBy("createdAt", "desc")
      .onSnapshot(snapshot => {
        activeDiv.innerHTML = "";
        snapshot.forEach(doc => renderPiano(doc, activeDiv));
      });

    db.collection("pianos").where("status", "==", "archived")
      .orderBy("createdAt", "desc")
      .onSnapshot(snapshot => {
        archiveDiv.innerHTML = "";
        snapshot.forEach(doc => renderPiano(doc, archiveDiv, true));
      });

    // Actions
    async function moveToArchive(id) {
      if (confirm("Mark this piano as sold?")) {
        await db.collection("pianos").doc(id).update({ status: "archived" });
      }
    }
    async function moveToActive(id) {
      if (confirm("Move this piano back to active?")) {
        await db.collection("pianos").doc(id).update({ status: "active" });
      }
    }
    async function deletePiano(id) {
      if (confirm("Are you sure you want to delete this piano?")) {
        await db.collection("pianos").doc(id).delete();
      }
    }
  </script>
</body>
</html>
