<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Piano Inventory</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    .tab { cursor: pointer; padding: 10px; margin-right: 5px; border: 1px solid #ccc; display: inline-block; }
    .tab.active { background: #eee; font-weight: bold; }
    .piano-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    button { margin: 5px; padding: 5px 10px; }
    .btn-delete { background: red; color: white; }
    .btn-sell { background: blue; color: white; }
    .btn-archive { background: gray; color: white; }
    .btn-add { background: green; color: white; }
    .filters { margin: 15px 0; padding: 10px; border: 1px solid #ddd; }
  </style>
</head>
<body>

<h1>Piano Inventory</h1>

<!-- Login -->
<div id="login-section">
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <button onclick="logout()" class="hidden" id="logoutBtn">Logout</button>
</div>

<!-- Tabs -->
<div>
  <span class="tab active" onclick="showTab('active')">Active</span>
  <span class="tab" onclick="showTab('sold')">Sold</span>
  <span class="tab" onclick="showTab('archive')">Archive</span>
</div>

<!-- Filters + Search -->
<div class="filters">
  <div style="margin-bottom:10px;">
    <input 
      type="text" 
      id="searchInput" 
      placeholder="Search pianos..." 
      style="width:250px; padding:5px;" 
      oninput="applyFilters()">
  </div>
  <label>Brand: 
    <select id="brandFilter" onchange="applyFilters()">
      <option value="">All</option>
      <option value="Yamaha">Yamaha</option>
      <option value="Steinway">Steinway</option>
      <option value="Kawai">Kawai</option>
      <option value="Baldwin">Baldwin</option>
    </select>
  </label>
  <label>Min Cost: <input type="number" id="minCost" onchange="applyFilters()"></label>
  <label>Max Cost: <input type="number" id="maxCost" onchange="applyFilters()"></label>
  <label>Size: 
    <select id="sizeFilter" onchange="applyFilters()">
      <option value="">All</option>
      <option value="Baby Grand">Baby Grand</option>
      <option value="Concert Grand">Concert Grand</option>
      <option value="Upright">Upright</option>
    </select>
  </label>
</div>

<!-- Add Piano Form -->
<div id="form-section" class="hidden">
  <h2>Add Piano</h2>
  <form id="pianoForm">
    <input type="text" id="brand" placeholder="Brand" required><br>
    <input type="text" id="model" placeholder="Model"><br>
    <input type="number" id="year" placeholder="Year"><br>
    <input type="text" id="color" placeholder="Color"><br>
    <input type="text" id="length" placeholder="Length"><br>
    <input type="number" id="cost" placeholder="Cost"><br>
    <select id="size">
      <option value="Baby Grand">Baby Grand</option>
      <option value="Concert Grand">Concert Grand</option>
      <option value="Upright">Upright</option>
    </select><br>
    <select id="location">
      <option value="Gallery">Gallery</option>
      <option value="Cartersville">Cartersville</option>
    </select><br>
    <label>Player System <input type="checkbox" id="playerSystem"></label><br>
    <label>Detailed <input type="checkbox" id="detailed"></label><br>
    <input type="date" id="detailDate"><br>
    <textarea id="notes" placeholder="Notes"></textarea><br>
    <input type="file" id="photo"><br>
    <button type="submit" class="btn-add">Add Piano</button>
  </form>
</div>

<!-- Listings -->
<div id="active-list"></div>
<div id="sold-list" class="hidden"></div>
<div id="archive-list" class="hidden"></div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyA2932IBDCeUix6OdRaJMDIisHX0SbyDFo",
    authDomain: "pianoinv.firebaseapp.com",
    projectId: "pianoinv",
    storageBucket: "pianoinv.appspot.com",
    messagingSenderId: "651707888262",
    appId: "1:651707888262:web:23131a782e31a7bb511707",
    measurementId: "G-1XQLEV28JZ"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  let currentUser = null;
  let allPianos = [];
  let filteredPianos = [];

  // Auth
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.getElementById("form-section").classList.remove("hidden");
      document.getElementById("logoutBtn").classList.remove("hidden");
    } else {
      currentUser = null;
      document.getElementById("form-section").classList.add("hidden");
      document.getElementById("logoutBtn").classList.add("hidden");
    }
  });

  function login() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    firebase.auth().signInWithEmailAndPassword(email, pass)
      .catch(err => alert(err.message));
  }
  function logout() {
    firebase.auth().signOut();
  }

  // Add piano
  document.getElementById("pianoForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    let photoURL = "";
    const photoFile = document.getElementById("photo").files[0];
    if (photoFile) {
      const storageRef = storage.ref("piano_photos/" + Date.now() + "_" + photoFile.name);
      await storageRef.put(photoFile);
      photoURL = await storageRef.getDownloadURL();
    }
    await db.collection("pianos").add({
      brand: document.getElementById("brand").value,
      model: document.getElementById("model").value,
      year: document.getElementById("year").value,
      color: document.getElementById("color").value,
      length: document.getElementById("length").value,
      size: document.getElementById("size").value,
      cost: parseFloat(document.getElementById("cost").value) || 0,
      location: document.getElementById("location").value,
      playerSystem: document.getElementById("playerSystem").checked,
      detailed: document.getElementById("detailed").checked,
      detailDate: document.getElementById("detailDate").value,
      notes: document.getElementById("notes").value,
      photoURL: photoURL,
      status: "active",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    e.target.reset();
  });

  // Render piano
  function renderPianos(pianos) {
    document.getElementById("active-list").innerHTML = "";
    document.getElementById("sold-list").innerHTML = "";
    document.getElementById("archive-list").innerHTML = "";

    pianos.forEach(doc => {
      const data = doc.data();
      const pianoDiv = document.createElement("div");
      pianoDiv.classList.add("piano-item");

      pianoDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div style="flex: 1;">
            <p><strong>Brand:</strong> ${data.brand}</p>
            <p><strong>Model:</strong> ${data.model}</p>
            <p><strong>Year:</strong> ${data.year}</p>
            <p><strong>Color:</strong> ${data.color}</p>
            <p><strong>Length:</strong> ${data.length}</p>
            <p><strong>Size:</strong> ${data.size || ""}</p>
            <p><strong>Cost:</strong> $${data.cost || 0}</p>
            <p><strong>Location:</strong> ${data.location}</p>
            <p><strong>Player System:</strong> ${data.playerSystem ? "Yes" : "No"}</p>
            <p><strong>Detailed:</strong> ${data.detailed ? "Yes (" + data.detailDate + ")" : "No"}</p>
            <p><strong>Notes:</strong> ${data.notes || ""}</p>
            ${currentUser ? `
              <button onclick="updateStatus('${doc.id}','sold')" class="btn-sell">Sell</button>
              <button onclick="updateStatus('${doc.id}','archive')" class="btn-archive">Archive</button>
              <button onclick="deletePiano('${doc.id}')" class="btn-delete">Delete</button>
            ` : ""}
          </div>
          ${data.photoURL ? `<img src="${data.photoURL}" alt="Piano Photo" style="max-width:200px; max-height:150px; object-fit:cover; margin-left:20px;">` : ""}
        </div>
      `;

      if (data.status === "active") document.getElementById("active-list").appendChild(pianoDiv);
      if (data.status === "sold") document.getElementById("sold-list").appendChild(pianoDiv);
      if (data.status === "archive") document.getElementById("archive-list").appendChild(pianoDiv);
    });
  }

  // Filters
  function applyFilters() {
    const brand = document.getElementById("brandFilter").value;
    const minCost = parseFloat(document.getElementById("minCost").value) || 0;
    const maxCost = parseFloat(document.getElementById("maxCost").value) || Infinity;
    const size = document.getElementById("sizeFilter").value;
    const searchText = document.getElementById("searchInput").value.toLowerCase();

    filteredPianos = allPianos.filter(doc => {
      const piano = doc.data();
      const matchesBrand = !brand || piano.brand === brand;
      const matchesCost = piano.cost >= minCost && piano.cost <= maxCost;
      const matchesSize = !size || piano.size === size;

      const matchesSearch = !searchText ||
        (piano.brand && piano.brand.toLowerCase().includes(searchText)) ||
        (piano.model && piano.model.toLowerCase().includes(searchText)) ||
        (piano.color && piano.color.toLowerCase().includes(searchText)) ||
        (piano.size && piano.size.toLowerCase().includes(searchText)) ||
        (piano.notes && piano.notes.toLowerCase().includes(searchText));

      return matchesBrand && matchesCost && matchesSize && matchesSearch;
    });

    renderPianos(filteredPianos);
  }

  // Update status
  function updateStatus(id, newStatus) {
    if (confirm("Are you sure you want to move this piano to " + newStatus + "?")) {
      db.collection("pianos").doc(id).update({ status: newStatus });
    }
  }

  // Delete
  function deletePiano(id) {
    if (confirm("Are you sure you want to delete this piano?")) {
      db.collection("pianos").doc(id).delete();
    }
  }

  // Tabs
  function showTab(tab) {
    ["active", "sold", "archive"].forEach(t => {
      document.getElementById(t+"-list").classList.add("hidden");
      document.querySelector(`.tab:nth-child(${["active","sold","archive"].indexOf(t)+1})`).classList.remove("active");
    });
    document.getElementById(tab+"-list").classList.remove("hidden");
    document.querySelector(`.tab:nth-child(${["active","sold","archive"].indexOf(tab)+1})`).classList.add("active");
  }

  // Realtime updates
  db.collection("pianos").orderBy("createdAt","desc").onSnapshot(snapshot => {
    allPianos = snapshot.docs;
    applyFilters(); // always apply filters when data updates
  });
</script>
</body>
</html>
