<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Piano Inventory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- HEIC to JPG conversion library -->
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
  <style>
    /* â€¦ your original CSS unchanged â€¦ */
  </style>
</head>
<body>
  <h1>ðŸŽ¹ Piano Inventory</h1>
  <button id="darkToggle" class="gray" style="margin-bottom:15px;">ðŸŒ™ Toggle Dark Mode</button>
  <button id="openModal" class="green" style="margin-bottom:15px; margin-left:10px;">âž• Add Piano</button>
  <div>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn" class="blue">Login</button>
    <button id="logoutBtn" class="gray hidden">Logout</button>
    <span id="whoami" class="muted"></span>
  </div>
  <div class="tabs">
    <div class="tab active" data-tab="active">Active</div>
    <div class="tab" data-tab="sold">Sold</div>
    <div class="tab" data-tab="archive">Archive</div>
  </div>
  <div class="filters">
    <label for="sortBy">Sort: </label>
    <select id="sortBy">
      <option value="createdAt">Created (newest)</option>
      <option value="profit">Profit (high â†’ low)</option>
    </select>
    <input type="text" id="searchBox" placeholder="Search (brand, model, year, notes, serial)">
    <select id="filterLocation">
      <option value="">All Locations</option>
      <option value="Gallery">Gallery</option>
      <option value="Cartersville">Cartersville</option>
    </select>
  </div>

  <div id="sold-summary" class="hidden"> â€¦ </div>
  <div id="active-list" class="grid"></div>
  <div id="sold-list" class="grid hidden"></div>
  <div id="archive-list" class="grid hidden"></div>

  <!-- Add/Edit Modal -->
  <div id="pianoModal" class="modal hidden">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h2 id="modalTitle">Add Piano</h2>
      <form id="pianoForm">
        <input type="text" id="brand" placeholder="Brand" required>
        <input type="text" id="model" placeholder="Model">
        <input type="number" id="year" placeholder="Year">
        <input type="text" id="color" placeholder="Color">
        <input type="text" id="length" placeholder="Length">
        <select id="location">
          <option value="Gallery">Gallery</option>
          <option value="Cartersville">Cartersville</option>
        </select>
        <input type="number" id="cost" placeholder="Buying Cost">
        <input type="number" id="listingPrice" placeholder="Listing Price">
        <input type="number" id="soldPrice" placeholder="Sold Price (if sold)">
        <input type="text" id="archiveReason" placeholder="Archive Reason (if archived)">
        <!-- âœ… new field -->
        <input type="text" id="serialNumber" placeholder="Serial Number">
        <textarea id="notes" placeholder="Notes"></textarea>
        <input type="file" id="photo" accept="image/*">
        <img id="photoPreview" src="" alt="Preview" style="max-width:100%; margin-top:10px; border-radius:6px; display:none;">
        <input type="hidden" id="editingId">
        <input type="hidden" id="currentPhotoURL">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="submit" id="submitBtn" class="green">Add Piano</button>
          <button type="button" id="cancelEditBtn" class="gray hidden">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Image Preview Modal + Toast -->
  <div id="imgPreviewModal" class="modal hidden"> â€¦ </div>
  <div id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, getDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
    const firebaseConfig={â€¦}; const app=initializeApp(firebaseConfig);
    const auth=getAuth(app); const db=getFirestore(app); const storage=getStorage(app);

    // â€¦ unchanged auth, toast, dark mode code â€¦

    // DOM bindings
    const pianoForm=document.getElementById("pianoForm");
    const editingId=document.getElementById("editingId");
    const brand=document.getElementById("brand");
    const model=document.getElementById("model");
    const year=document.getElementById("year");
    const color=document.getElementById("color");
    const lengthInput=document.getElementById("length");
    const locationInput=document.getElementById("location");
    const cost=document.getElementById("cost");
    const listingPrice=document.getElementById("listingPrice");
    const soldPrice=document.getElementById("soldPrice");
    const archiveReason=document.getElementById("archiveReason");
    const notes=document.getElementById("notes");
    const serialNumber=document.getElementById("serialNumber"); // âœ… new
    const photo=document.getElementById("photo");
    const photoPreview=document.getElementById("photoPreview");
    const currentPhotoURL=document.getElementById("currentPhotoURL");
    const submitBtn=document.getElementById("submitBtn");
    const cancelEditBtn=document.getElementById("cancelEditBtn");

    function resetForm(){ pianoForm.reset(); editingId.value=""; currentPhotoURL.value="";
      photoPreview.src=""; photoPreview.style.display="none"; serialNumber.value=""; // âœ… clear serial
      submitBtn.textContent="Add Piano"; submitBtn.classList.remove("orange"); submitBtn.classList.add("green"); cancelEditBtn.classList.add("hidden");
    }

    function setEdit(id,data){
      editingId.value=id; brand.value=data.brand||""; model.value=data.model||"";
      year.value=data.year!=null?data.year:""; color.value=data.color||"";
      lengthInput.value=data.length||""; locationInput.value=data.location||"Gallery";
      cost.value=data.cost!=null?data.cost:""; listingPrice.value=data.listingPrice!=null?data.listingPrice:"";
      soldPrice.value=data.soldPrice!=null?data.soldPrice:""; archiveReason.value=data.archiveReason||"";
      notes.value=data.notes||""; serialNumber.value=data.serialNumber||""; // âœ… fill serial
      currentPhotoURL.value=data.photoURL||"";
      // â€¦ photo preview code unchanged â€¦
    }

    // Save piano
    pianoForm.addEventListener("submit",async e=>{
      e.preventDefault(); if(!currentUser){showToast("Sign in required");return;}
      const id=editingId.value;
      const data={ brand:brand.value||null, model:model.value||null, year:year.value?+year.value:null,
        color:color.value||null, length:lengthInput.value||null, location:locationInput.value||null,
        cost:cost.value?+cost.value:null, listingPrice:listingPrice.value?+listingPrice.value:null,
        soldPrice:soldPrice.value?+soldPrice.value:null, archiveReason:archiveReason.value||null,
        notes:notes.value||null, serialNumber:serialNumber.value||null // âœ… save serial
      };
      // â€¦ photo handling + Firestore save unchanged â€¦
    });

    function render(){
      // â€¦ unchanged up to search â€¦
      const q=document.getElementById("searchBox").value.toLowerCase();
      if(q){ filtered=filtered.filter(d=>
        (d.brand||"").toLowerCase().includes(q)||
        (d.model||"").toLowerCase().includes(q)||
        (d.notes||"").toLowerCase().includes(q)||
        (d.year?.toString()||"").includes(q)||
        (d.serialNumber||"").toLowerCase().includes(q) // âœ… search serial
      ); }
      // â€¦ rest unchanged â€¦
      for(const d of filtered){
        const c=document.createElement("div"); c.className="card";
        c.innerHTML=`
          ${d.photoURL?`<div><img src="${d.photoURL}" ...></div>`:""}
          <h3>${(d.brand||"")+(d.model?" "+d.model:"")}</h3>
          <div class="meta">
            Status: ${d.status||"active"}
            ${d.year?" â€¢ Year "+d.year:""}
            ${d.color?" â€¢ "+d.color:""}
            ${d.location?" â€¢ "+d.location:""}
            ${d.serialNumber?` â€¢ SN: ${d.serialNumber}`:""} <!-- âœ… show serial -->
          </div>
          ${d.notes?`<div class="meta">${d.notes}</div>`:""}
          ${extra}
          <div class="actions"> â€¦ </div>`;
        // â€¦ append unchanged â€¦
      }
    }
    // â€¦ rest unchanged â€¦
  </script>
</body>
</html>
