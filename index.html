<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Piano Inventory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --muted:#aab2c0; --text:#f5f7fb; --accent:#6aa6ff;
      --green:#22c55e; --red:#ef4444; --orange:#f59e0b; --blue:#3b82f6; --gray:#6b7280;
      --border:#242936; --chip:#1f2430;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Arial,Helvetica,sans-serif;
      background:linear-gradient(180deg,#0e1014 0%, #0f1115 100%); color:var(--text);
      -webkit-font-smoothing:antialiased; padding:24px;
    }
    h1{margin:0 0 16px; font-size:28px; letter-spacing:.2px}
    .app{max-width:1100px; margin:0 auto}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:16px;
    }
    .auth{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    input[type="email"], input[type="password"], input[type="text"], input[type="number"], input[type="date"], textarea, select {
      background:var(--card); border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:10px 12px; outline:none; min-width:180px;
    }
    textarea{min-height:80px; width:100%}
    button{
      background:var(--chip); color:var(--text); border:1px solid var(--border);
      border-radius:10px; padding:10px 14px; cursor:pointer;
    }
    button.primary{background:var(--accent); border-color:transparent; color:#0c1220; font-weight:600}
    button.green{background:var(--green); color:#07140b; border-color:transparent}
    button.red{background:var(--red); color:#190506; border-color:transparent}
    button.blue{background:var(--blue); color:#061225; border-color:transparent}
    button.gray{background:var(--gray); color:#0e1014; border-color:transparent}
    button.orange{background:var(--orange); color:#140c00; border-color:transparent}
    button:disabled{opacity:.6; cursor:not-allowed}

    .tabs{display:flex; gap:8px; margin:8px 0 16px}
    .tab{padding:10px 14px; border:1px solid var(--border); border-radius:999px; background:var(--chip); cursor:pointer}
    .tab.active{background:var(--accent); color:#08101f; font-weight:700; border-color:transparent}

    .controls{display:flex; gap:10px; flex-wrap:wrap; margin:0 0 16px}
    .controls .grow{flex:1 1 280px}

    .grid{display:grid; grid-template-columns: repeat(auto-fill,minmax(310px,1fr)); gap:14px}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden;
      display:flex; flex-direction:column; min-height:180px;
    }
    .card .media{width:100%; height:180px; background:#0c0f15; display:flex; align-items:center; justify-content:center}
    .card img{width:100%; height:100%; object-fit:cover}
    .card .body{padding:12px 14px; display:flex; flex-direction:column; gap:6px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .meta{color:var(--muted); font-size:12px}
    .chips{display:flex; gap:6px; flex-wrap:wrap}
    .chip{background:var(--chip); border:1px solid var(--border); color:var(--muted); padding:4px 8px; border-radius:999px; font-size:12px}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}

    .section{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; margin:16px 0}
    .section h2{margin:0 0 8px; font-size:18px}

    .hidden{display:none}
    .toast{
      position:fixed; right:16px; bottom:16px; background:#10161f; border:1px solid #1b2432;
      color:#e9f0ff; padding:12px 14px; border-radius:12px; opacity:0; transform:translateY(8px);
      transition:all .25s ease; pointer-events:none; box-shadow:0 8px 30px rgba(5,12,26,.35);
    }
    .toast.show{opacity:1; transform:translateY(0)}
    .uploader{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .preview{width:120px; height:90px; border:1px dashed var(--border); border-radius:10px; display:flex; align-items:center; justify-content:center; overflow:hidden; background:#0c0f15}
    .preview img{width:100%; height:100%; object-fit:cover}
    .muted{color:var(--muted)}
    .divider{height:1px; background:var(--border); margin:8px 0}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <h1>ðŸŽ¹ Piano Inventory</h1>
    <div class="auth" id="auth">
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button class="primary" id="loginBtn">Login</button>
      <button class="gray hidden" id="logoutBtn">Logout</button>
      <span class="muted" id="whoami"></span>
    </div>
  </div>

  <div class="tabs" role="tablist">
    <button class="tab active" data-tab="active">Active</button>
    <button class="tab" data-tab="sold">Sold</button>
    <button class="tab" data-tab="archive">Archive</button>
  </div>

  <div class="controls">
    <input class="grow" type="text" id="q" placeholder="Search brand, model, color, notesâ€¦" />
    <select id="filterLocation">
      <option value="">All locations</option>
      <option value="Gallery">Gallery</option>
      <option value="Cartersville">Cartersville</option>
    </select>
    <select id="sortBy">
      <option value="createdAt">Sort: Created (newest)</option>
      <option value="year">Sort: Year (newest)</option>
      <option value="brand">Sort: Brand (Aâ€“Z)</option>
      <option value="listingPrice">Sort: Listing (highâ†’low)</option>
    </select>
    <button id="clearFilters" class="gray">Clear</button>
  </div>

  <!-- Add / Edit -->
  <div id="form-section" class="section hidden">
    <h2 id="formTitle">Add Piano</h2>
    <form id="pianoForm">
      <div class="row">
        <input type="text" id="brand" placeholder="Brand *" required />
        <input type="text" id="model" placeholder="Model" />
        <input type="number" id="year" placeholder="Year" min="1800" max="2100" class="nowrap" />
        <input type="text" id="color" placeholder="Color" />
        <input type="text" id="length" placeholder="Length" />
      </div>
      <div class="row">
        <select id="location">
          <option value="Gallery">Gallery</option>
          <option value="Cartersville">Cartersville</option>
        </select>
        <label><input type="checkbox" id="playerSystem" /> Player System</label>
        <label><input type="checkbox" id="detailed" /> Detailed</label>
        <input type="date" id="detailDate" />
      </div>
      <div class="row">
        <input type="number" id="cost" placeholder="Cost" step="0.01" />
        <input type="number" id="listingPrice" placeholder="Listing Price" step="0.01" />
      </div>
      <div>
        <textarea id="notes" placeholder="Notes" ></textarea>
      </div>
      <div class="uploader">
        <div class="preview" id="preview"><span class="muted">No photo</span></div>
        <input type="file" id="photo" accept="image/*" />
      </div>
      <div class="row" style="margin-top:10px">
        <button type="submit" class="green" id="submitBtn">Add Piano</button>
        <button type="button" class="gray hidden" id="cancelEditBtn">Cancel Edit</button>
      </div>
      <input type="hidden" id="editingId" />
    </form>
  </div>

  <!-- Lists -->
  <div id="active-list" class="grid" role="tabpanel" aria-label="Active"></div>
  <div id="sold-list" class="grid hidden" role="tabpanel" aria-label="Sold"></div>
  <div id="archive-list" class="grid hidden" role="tabpanel" aria-label="Archive"></div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase v9 modular (ESM via CDN) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp,
    query, orderBy, getDoc
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import {
    getStorage, ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  // --- Firebase config (your existing project) ---
  const firebaseConfig = {
    apiKey: "AIzaSyA2932IBDCeUix6OdRaJMDIisHX0SbyDFo",
    authDomain: "pianoinv.firebaseapp.com",
    projectId: "pianoinv",
    storageBucket: "pianoinv.appspot.com",
    messagingSenderId: "651707888262",
    appId: "1:651707888262:web:23131a782e31a7bb511707",
    measurementId: "G-1XQLEV28JZ"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // --- UI refs ---
  const emailEl = document.getElementById("email");
  const passwordEl = document.getElementById("password");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const whoami = document.getElementById("whoami");
  const formSection = document.getElementById("form-section");
  const activeList = document.getElementById("active-list");
  const soldList = document.getElementById("sold-list");
  const archiveList = document.getElementById("archive-list");
  const toastEl = document.getElementById("toast");
  const tabs = [...document.querySelectorAll(".tab")];
  const searchEl = document.getElementById("q");
  const filterLocationEl = document.getElementById("filterLocation");
  const sortByEl = document.getElementById("sortBy");
  const clearFiltersBtn = document.getElementById("clearFilters");
  const previewEl = document.getElementById("preview");
  const photoEl = document.getElementById("photo");
  const pianoForm = document.getElementById("pianoForm");
  const submitBtn = document.getElementById("submitBtn");
  const formTitle = document.getElementById("formTitle");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const editingIdEl = document.getElementById("editingId");

  // Form fields
  const brandEl = document.getElementById("brand");
  const modelEl = document.getElementById("model");
  const yearEl = document.getElementById("year");
  const colorEl = document.getElementById("color");
  const lengthEl = document.getElementById("length");
  const locationEl = document.getElementById("location");
  const playerSystemEl = document.getElementById("playerSystem");
  const detailedEl = document.getElementById("detailed");
  const detailDateEl = document.getElementById("detailDate");
  const notesEl = document.getElementById("notes");
  const costEl = document.getElementById("cost");
  const listingPriceEl = document.getElementById("listingPrice");

  let currentUser = null;
  let allDocs = []; // cache from snapshot
  let currentTab = "active";

  // --- Helpers ---
  const $ = (sel, root=document)=>root.querySelector(sel);
  function showToast(msg){ toastEl.textContent = msg; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"), 2200); }
  function fmtMoney(n){ if(n===null || n===undefined || n==="") return "â€”"; const v = Number(n); if(Number.isNaN(v)) return "â€”"; return v.toLocaleString(undefined,{style:"currency", currency:"USD", maximumFractionDigits:0}); }
  function profitOf(d){ if(d?.listingPrice==null || d?.cost==null) return null; return Number(d.listingPrice) - Number(d.cost); }
  function imgHTML(url){ return url ? `<img src="${url}" alt="Piano Photo" />` : `<div class="muted">No image</div>`; }
  function serializeForm(){
    return {
      brand: brandEl.value.trim(),
      model: modelEl.value.trim(),
      year: yearEl.value ? Number(yearEl.value) : null,
      color: colorEl.value.trim(),
      length: lengthEl.value.trim(),
      location: locationEl.value,
      playerSystem: playerSystemEl.checked,
      detailed: detailedEl.checked,
      detailDate: detailDateEl.value || "",
      notes: notesEl.value.trim(),
      cost: costEl.value ? Number(costEl.value) : null,
      listingPrice: listingPriceEl.value ? Number(listingPriceEl.value) : null,
    }
  }
  function resetForm(){
    pianoForm.reset();
    $('#editingId').value = "";
    previewEl.innerHTML = `<span class="muted">No photo</span>`;
    submitBtn.textContent = "Add Piano";
    submitBtn.classList.remove("orange");
    submitBtn.classList.add("green");
    formTitle.textContent = "Add Piano";
    cancelEditBtn.classList.add("hidden");
  }
  function setEditMode(docId, data){
    $('#editingId').value = docId;
    brandEl.value = data.brand || "";
    modelEl.value = data.model || "";
    yearEl.value = data.year || "";
    colorEl.value = data.color || "";
    lengthEl.value = data.length || "";
    locationEl.value = data.location || "Gallery";
    playerSystemEl.checked = !!data.playerSystem;
    detailedEl.checked = !!data.detailed;
    detailDateEl.value = data.detailDate || "";
    notesEl.value = data.notes || "";
    costEl.value = data.cost ?? "";
    listingPriceEl.value = data.listingPrice ?? "";
    if(data.photoURL){
      previewEl.innerHTML = `<img src="${data.photoURL}" alt="preview" />`;
    } else {
      previewEl.innerHTML = `<span class="muted">No photo</span>`;
    }
    submitBtn.textContent = "Save Changes";
    submitBtn.classList.remove("green");
    submitBtn.classList.add("orange");
    formTitle.textContent = "Edit Piano";
    cancelEditBtn.classList.remove("hidden");
    window.scrollTo({top:0, behavior:"smooth"});
  }

  // --- Auth ---
  loginBtn.addEventListener("click", async ()=>{
    try{
      await signInWithEmailAndPassword(auth, emailEl.value, passwordEl.value);
    }catch(e){ showToast(e.message || "Login error"); }
  });
  logoutBtn.addEventListener("click", async ()=>{ await signOut(auth); });

  onAuthStateChanged(auth, (user)=>{
    currentUser = user || null;
    if(user){
      whoami.textContent = `Signed in as ${user.email}`;
      logoutBtn.classList.remove("hidden");
      $('#loginBtn').classList.add("hidden");
      emailEl.classList.add("hidden");
      passwordEl.classList.add("hidden");
      formSection.classList.remove("hidden");
    }else{
      whoami.textContent = "";
      logoutBtn.classList.add("hidden");
      $('#loginBtn').classList.remove("hidden");
      emailEl.classList.remove("hidden");
      passwordEl.classList.remove("hidden");
      formSection.classList.add("hidden");
    }
  });

  // --- Photo preview ---
  photoEl.addEventListener("change", ()=>{
    const f = photoEl.files?.[0];
    if(!f){ previewEl.innerHTML = `<span class="muted">No photo</span>`; return; }
    const url = URL.createObjectURL(f);
    previewEl.innerHTML = `<img src="${url}" alt="preview"/>`;
  });

  // --- Add / Edit submit ---
  pianoForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!currentUser){ showToast("Please sign in"); return; }

    submitBtn.disabled = true;
    try{
      const data = serializeForm();
      let photoURL = null;

      const newPhotoFile = photoEl.files?.[0];
      if(newPhotoFile){
        const storageRef = ref(storage, `piano_photos/${Date.now()}_${newPhotoFile.name}`);
        await uploadBytes(storageRef, newPhotoFile);
        photoURL = await getDownloadURL(storageRef);
      }

      const editingId = editingIdEl.value;
      if(editingId){
        const refDoc = doc(db, "pianos", editingId);
        const existing = (await getDoc(refDoc)).data() || {};
        const updates = { ...data };
        if(photoURL) updates.photoURL = photoURL; // only overwrite if new photo chosen
        await updateDoc(refDoc, updates);
        showToast("Piano updated");
      }else{
        await addDoc(collection(db, "pianos"), {
          ...data,
          photoURL: photoURL || "",
          status: "active",
          createdAt: serverTimestamp()
        });
        showToast("Piano added");
      }
      resetForm();
      photoEl.value = "";
    }catch(e){
      console.error(e);
      showToast("Save error");
    }finally{
      submitBtn.disabled = false;
    }
  });

  cancelEditBtn.addEventListener("click", resetForm);

  // --- Status helpers (Sell / Archive / Delete) ---
  async function updateStatus(id, newStatus){
    if(!currentUser){ showToast("Please sign in"); return; }
    const refDoc = doc(db, "pianos", id);
    if(newStatus === "sold"){
      if(!confirm("Mark as SOLD?")) return;
      await updateDoc(refDoc, { status:"sold", soldAt: serverTimestamp() });
      showToast("Marked as sold");
    }else if(newStatus === "archive"){
      const reason = prompt("Archive reason? (optional)") || "";
      await updateDoc(refDoc, { status:"archive", archiveReason: reason, archivedAt: serverTimestamp() });
      showToast("Moved to archive");
    }else if(newStatus === "active"){
      await updateDoc(refDoc, { status:"active" });
      showToast("Moved to active");
    }
  }
  async function deletePiano(id){
    if(!currentUser){ showToast("Please sign in"); return; }
    if(!confirm("Delete this piano permanently?")) return;
    await deleteDoc(doc(db,"pianos",id));
    showToast("Deleted");
  }

  // --- Render ---
  function render(){
    const q = (searchEl.value || "").toLowerCase().trim();
    const loc = filterLocationEl.value;
    const sortBy = sortByEl.value;

    const filtered = allDocs.filter(x=>{
      if(x.status !== currentTab) return false;
      if(loc && x.location !== loc) return false;
      if(!q) return true;
      const hay = [x.brand,x.model,x.color,x.notes,x.location,String(x.year||"")].join(" ").toLowerCase();
      return hay.includes(q);
    });

    filtered.sort((a,b)=>{
      if(sortBy === "createdAt"){
        const av = a.createdAt? a.createdAt.toMillis():0;
        const bv = b.createdAt? b.createdAt.toMillis():0;
        return bv-av;
      }
      if(sortBy === "year"){
        const av = a.year || 0, bv = b.year || 0;
        return bv-av;
      }
      if(sortBy === "brand"){
        return (a.brand||"").localeCompare(b.brand||"");
      }
      if(sortBy === "listingPrice"){
        const av = a.listingPrice || 0, bv = b.listingPrice || 0;
        return bv-av;
      }
      return 0;
    });

    const containerMap = {
      active: activeList,
      sold: soldList,
      archive: archiveList
    };
    // Clear all
    activeList.innerHTML = "";
    soldList.innerHTML = "";
    archiveList.innerHTML = "";

    const container = containerMap[currentTab];

    for(const d of filtered){
      const pft = profitOf(d);
      const moreMeta = [];
      if(d.year) moreMeta.push(`Year ${d.year}`);
      if(d.color) moreMeta.push(d.color);
      if(d.length) moreMeta.push(d.length);
      if(d.playerSystem) moreMeta.push("Player");

      const soldTag = d.soldAt?.toDate ? `Sold: ${d.soldAt.toDate().toLocaleDateString()}` : "";
      const archivedTag = d.archivedAt?.toDate ? `Archived: ${d.archivedAt.toDate().toLocaleDateString()}` : "";

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="media">${imgHTML(d.photoURL)}</div>
        <div class="body">
          <div class="row">
            <div>
              <div style="font-weight:700; font-size:15px">${d.brand || "Unknown"}${d.model ? " " + d.model : ""}</div>
              <div class="meta">${moreMeta.join(" â€¢ ") || "&nbsp;"}</div>
            </div>
            <div class="chips">
              <span class="chip">${d.location || "â€”"}</span>
              <span class="chip">${(d.status||"").toUpperCase()}</span>
            </div>
          </div>

          <div class="row">
            <div class="meta">Cost: <strong>${fmtMoney(d.cost)}</strong></div>
            <div class="meta">List: <strong>${fmtMoney(d.listingPrice)}</strong></div>
            <div class="meta">Profit: <strong>${pft==null?"â€”":fmtMoney(pft)}</strong></div>
          </div>

          ${d.notes ? `<div class="divider"></div><div class="meta">${d.notes}</div>` : ""}

          <div class="chips">
            ${soldTag ? `<span class="chip">${soldTag}</span>` : ""}
            ${archivedTag ? `<span class="chip">${archivedTag}</span>` : ""}
            ${d.detailed ? `<span class="chip">Detailed${d.detailDate ? " ("+d.detailDate+")":""}</span>` : ""}
          </div>

          <div class="actions">
            ${currentUser ? `
              ${d.status!=="sold" ? `<button class="blue" data-act="sell" data-id="${d._id}">Sell</button>` : ""}
              ${d.status!=="archive" ? `<button class="gray" data-act="archive" data-id="${d._id}">Archive</button>` : ""}
              ${d.status!=="active" ? `<button class="green" data-act="activate" data-id="${d._id}">Set Active</button>` : ""}
              <button class="orange" data-act="edit" data-id="${d._id}">Edit</button>
              <button class="red" data-act="delete" data-id="${d._id}">Delete</button>
            `: ""}
          </div>
        </div>
      `;
      // Action handlers
      card.addEventListener("click", (ev)=>{
        const btn = ev.target.closest("button[data-act]");
        if(!btn) return;
        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        if(act==="sell") updateStatus(id,"sold");
        if(act==="archive") updateStatus(id,"archive");
        if(act==="activate") updateStatus(id,"active");
        if(act==="delete") deletePiano(id);
        if(act==="edit"){
          const found = allDocs.find(x=>x._id===id);
          if(found) setEditMode(id, found);
        }
      });

      container.appendChild(card);
    }
  }

  // --- Tabs ---
  tabs.forEach(t=>{
    t.addEventListener("click", ()=>{
      tabs.forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      currentTab = t.dataset.tab;
      // show/hide lists
      activeList.classList.toggle("hidden", currentTab!=="active");
      soldList.classList.toggle("hidden", currentTab!=="sold");
      archiveList.classList.toggle("hidden", currentTab!=="archive");
      render();
    });
  });

  // --- Filters ---
  [searchEl, filterLocationEl, sortByEl].forEach(el=>{
    el.addEventListener("input", ()=>render());
    el.addEventListener("change", ()=>render());
  });
  clearFiltersBtn.addEventListener("click", ()=>{
    searchEl.value = "";
    filterLocationEl.value = "";
    sortByEl.value = "createdAt";
    render();
  });

  // --- Live query (all pianos, sorted by createdAt desc) ---
  const qRef = query(collection(db,"pianos"), orderBy("createdAt","desc"));
  onSnapshot(qRef, (snap)=>{
    allDocs = snap.docs.map(d=>{
      const data = d.data();
      return { ...data, _id: d.id };
    });
    render();
  });

</script>
</body>
</html>
