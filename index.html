<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Piano Inventory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; margin:0; padding:20px; color:#111; }
    h1 { margin:0 0 20px; }
    .tabs { display:flex; gap:10px; margin-bottom:20px; }
    .tab { padding:8px 14px; border:1px solid #ccc; cursor:pointer; border-radius:6px; background:#fff; }
    .tab.active { background:#007bff; color:#fff; font-weight:bold; border-color:#007bff; }
    .filters { margin-bottom:20px; display:flex; gap:10px; align-items:center; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(300px,1fr)); gap:12px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; }
    .card h3 { margin:0 0 8px; }
    .meta { font-size:14px; color:#555; }
    .actions { margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; }
    button { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; }
    .green { background:#28a745; color:#fff; }
    .blue { background:#007bff; color:#fff; }
    .orange { background:#fd7e14; color:#fff; }
    .red { background:#dc3545; color:#fff; }
    .gray { background:#6c757d; color:#fff; }
    .hidden { display:none; }
    form input, form textarea, form select { width:100%; margin:6px 0; padding:8px; border:1px solid #ccc; border-radius:6px; }
    #toast { position:fixed; bottom:20px; right:20px; background:#333; color:#fff; padding:10px 14px; border-radius:6px; opacity:0; transition:opacity .3s; }
    #toast.show { opacity:1; }
    #sold-summary { margin:15px 0; padding:12px; background:#fff; border:1px solid #ddd; border-radius:6px; }
    #sold-summary .row { display:flex; gap:16px; flex-wrap:wrap; }
    #sold-summary .row > div { min-width:220px; }
    .muted { color:#666; }
  </style>
</head>
<body>
  <h1>ðŸŽ¹ Piano Inventory</h1>

  <!-- Auth -->
  <div>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn" class="blue">Login</button>
    <button id="logoutBtn" class="gray hidden">Logout</button>
    <span id="whoami" class="muted"></span>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="active">Active</div>
    <div class="tab" data-tab="sold">Sold</div>
    <div class="tab" data-tab="archive">Archive</div>
  </div>

  <!-- Sort dropdown -->
  <div class="filters">
    <label for="sortBy">Sort by: </label>
    <select id="sortBy">
      <option value="createdAt">Created (newest)</option>
      <option value="profit">Profit (high â†’ low)</option>
    </select>
  </div>

  <!-- Form -->
  <form id="pianoForm" class="hidden">
    <input type="text" id="brand" placeholder="Brand" required>
    <input type="text" id="model" placeholder="Model">
    <input type="number" id="year" placeholder="Year">
    <input type="text" id="color" placeholder="Color">
    <input type="text" id="length" placeholder="Length">
    <select id="location">
      <option value="Gallery">Gallery</option>
      <option value="Cartersville">Cartersville</option>
    </select>
    <input type="number" id="cost" placeholder="Buying Cost">
    <input type="number" id="listingPrice" placeholder="Listing Price">
    <input type="number" id="soldPrice" placeholder="Sold Price (if sold)">
    <input type="text" id="archiveReason" placeholder="Archive Reason (if archived)">
    <textarea id="notes" placeholder="Notes"></textarea>
    <input type="file" id="photo" accept="image/*">
    <input type="hidden" id="editingId">
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button type="submit" id="submitBtn" class="green">Add Piano</button>
      <button type="button" id="cancelEditBtn" class="gray hidden">Cancel</button>
    </div>
  </form>

  <!-- Sold summary (shows only in Sold tab) -->
  <div id="sold-summary" class="hidden">
    <strong>Sold Summary</strong>
    <div class="row">
      <div>Total Sales: <span id="sumSales">$0</span></div>
      <div>Total Cost: <span id="sumCost">$0</span></div>
      <div>Total Profit: <span id="sumProfit">$0</span></div>
      <div>Total Commissions (15%): <span id="sumComm">$0.00</span></div>
    </div>
  </div>

  <!-- Lists -->
  <div id="active-list" class="grid"></div>
  <div id="sold-list" class="grid hidden"></div>
  <div id="archive-list" class="grid hidden"></div>

  <div id="toast"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, getDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2932IBDCeUix6OdRaJMDIisHX0SbyDFo",
      authDomain: "pianoinv.firebaseapp.com",
      projectId: "pianoinv",
      storageBucket: "pianoinv.appspot.com",
      messagingSenderId: "651707888262",
      appId: "1:651707888262:web:23131a782e31a7bb511707",
      measurementId: "G-1XQLEV28JZ"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ---- UI refs
    const toast = document.getElementById("toast");
    const pianoForm = document.getElementById("pianoForm");
    const submitBtn = document.getElementById("submitBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const activeListEl = document.getElementById("active-list");
    const soldListEl = document.getElementById("sold-list");
    const archiveListEl = document.getElementById("archive-list");
    const soldSummaryEl = document.getElementById("sold-summary");
    const sumSalesEl = document.getElementById("sumSales");
    const sumCostEl = document.getElementById("sumCost");
    const sumProfitEl = document.getElementById("sumProfit");
    const sumCommEl = document.getElementById("sumComm");
    const sortByEl = document.getElementById("sortBy");

    // Form fields
    const brand = document.getElementById("brand");
    const model = document.getElementById("model");
    const year = document.getElementById("year");
    const color = document.getElementById("color");
    const length = document.getElementById("length");
    const locationSel = document.getElementById("location");
    const cost = document.getElementById("cost");
    const listingPrice = document.getElementById("listingPrice");
    const soldPrice = document.getElementById("soldPrice");
    const archiveReason = document.getElementById("archiveReason");
    const notes = document.getElementById("notes");
    const photo = document.getElementById("photo");
    const editingId = document.getElementById("editingId");

    function showToast(m){ toast.textContent = m; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"), 2000); }
    function money(n){ return (n==null || isNaN(n)) ? "â€”" : n.toLocaleString(undefined,{style:"currency",currency:"USD"}); }

    // ---- Auth
    let currentUser = null;
    onAuthStateChanged(auth, u=>{
      currentUser = u;
      pianoForm.classList.toggle("hidden", !u);
      document.getElementById("loginBtn").classList.toggle("hidden", !!u);
      document.getElementById("logoutBtn").classList.toggle("hidden", !u);
      document.getElementById("whoami").textContent = u ? u.email : "";
    });
    loginBtn.onclick = ()=>signInWithEmailAndPassword(auth, email.value, password.value).catch(e=>showToast(e.message));
    logoutBtn.onclick = ()=>signOut(auth);

    // ---- State
    let docsCache = [];             // full set from Firestore
    let currentTab = "active";      // active | sold | archive

    // ---- Form helpers
    function resetForm(){
      pianoForm.reset();
      editingId.value = "";
      submitBtn.textContent = "Add Piano";
      submitBtn.classList.remove("orange");
      submitBtn.classList.add("green");
      cancelEditBtn.classList.add("hidden");
      photo.value = "";
    }
    function setEdit(id, data){
      editingId.value = id;
      brand.value = data.brand || "";
      model.value = data.model || "";
      year.value = data.year || "";
      color.value = data.color || "";
      length.value = data.length || "";
      locationSel.value = data.location || "Gallery";
      cost.value = (data.cost ?? "");
      listingPrice.value = (data.listingPrice ?? "");
      soldPrice.value = (data.soldPrice ?? "");
      archiveReason.value = data.archiveReason || "";
      notes.value = data.notes || "";
      submitBtn.textContent = "Save Changes";
      submitBtn.classList.remove("green");
      submitBtn.classList.add("orange");
      cancelEditBtn.classList.remove("hidden");
      window.scrollTo({top:0, behavior:"smooth"});
    }
    cancelEditBtn.onclick = resetForm;

    // ---- Add / Update
    pianoForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!currentUser){ showToast("Sign in required"); return; }

      const id = editingId.value;
      const data = {
        brand: brand.value,
        model: model.value,
        year: year.value ? +year.value : null,
        color: color.value,
        length: length.value,
        location: locationSel.value,
        cost: cost.value ? +cost.value : null,
        listingPrice: listingPrice.value ? +listingPrice.value : null,
        soldPrice: soldPrice.value ? +soldPrice.value : null,
        archiveReason: archiveReason.value,
        notes: notes.value
      };

      let photoURL = null;
      if(photo.files[0]){
        const sref = ref(storage, "piano_photos/" + Date.now() + "_" + photo.files[0].name);
        await uploadBytes(sref, photo.files[0]);
        photoURL = await getDownloadURL(sref);
      }

      if(id){
        const refDoc = doc(db, "pianos", id);
        if(photoURL) data.photoURL = photoURL;
        await updateDoc(refDoc, data);
        showToast("Updated");
      }else{
        await addDoc(collection(db, "pianos"), {
          ...data,
          photoURL: photoURL || "",
          status: "active",
          createdAt: serverTimestamp()
        });
        showToast("Added");
      }
      resetForm();
    });

    // ---- Status actions
    async function updateStatus(id, status){
      if(!currentUser){ showToast("Sign in required"); return; }
      const refDoc = doc(db, "pianos", id);

      if(status === "sold"){
        let price = prompt("Sold price? (leave blank to use listing price)");
        await updateDoc(refDoc, {
          status: "sold",
          soldAt: serverTimestamp(),
          soldPrice: price ? +price : null
        });
      }else if(status === "archive"){
        let reason = prompt("Archive reason?") || "";
        await updateDoc(refDoc, {
          status: "archive",
          archivedAt: serverTimestamp(),
          archiveReason: reason
        });
      }else{
        await updateDoc(refDoc, { status });
      }
    }
    async function deletePiano(id){
      if(!currentUser){ showToast("Sign in required"); return; }
      if(confirm("Delete this piano?")){
        await deleteDoc(doc(db, "pianos", id));
      }
    }

    // ---- Render
    function render(){
      // Containers visibility by tab
      activeListEl.classList.toggle("hidden", currentTab !== "active");
      soldListEl.classList.toggle("hidden", currentTab !== "sold");
      archiveListEl.classList.toggle("hidden", currentTab !== "archive");
      soldSummaryEl.classList.toggle("hidden", currentTab !== "sold");

      // Clear lists
      activeListEl.innerHTML = "";
      soldListEl.innerHTML = "";
      archiveListEl.innerHTML = "";

      // Sorting
      const sortBy = sortByEl.value;
      const sorted = [...docsCache];

      if(sortBy === "profit"){
        sorted.sort((a,b)=>{
          const ap = (a.soldPrice ?? a.listingPrice ?? 0) - (a.cost ?? 0);
          const bp = (b.soldPrice ?? b.listingPrice ?? 0) - (b.cost ?? 0);
          return bp - ap; // high â†’ low
        });
      }else{ // createdAt
        sorted.sort((a,b)=>{
          const at = a.createdAt?.toMillis?.() || 0;
          const bt = b.createdAt?.toMillis?.() || 0;
          return bt - at;
        });
      }

      // Summary (across all sold pianos)
      if(currentTab === "sold"){
        const solds = docsCache.filter(d => d.status === "sold");
        let totalSales = 0, totalCost = 0, totalProfit = 0, totalComm = 0;

        for(const d of solds){
          const sp = (d.soldPrice != null ? d.soldPrice : d.listingPrice) || 0;
          const c  = d.cost || 0;
          const profit = (d.soldPrice != null || d.listingPrice != null) && d.cost != null ? (sp - c) : null;
          const comm   = profit != null ? profit * 0.15 : null;

          totalSales += sp || 0;
          totalCost  += c  || 0;
          if(profit != null) totalProfit += profit;
          if(comm   != null) totalComm   += comm;
        }

        sumSalesEl.textContent  = money(totalSales);
        sumCostEl.textContent   = money(totalCost);
        sumProfitEl.textContent = money(totalProfit);
        sumCommEl.textContent   = (isNaN(totalComm) ? "$0.00" : totalComm.toLocaleString(undefined,{style:"currency",currency:"USD"}));
      }

      // Cards
      for(const d of sorted){
        const card = document.createElement("div");
        card.className = "card";

        let extra = "";
        if(d.status === "sold" && d.soldAt?.toDate){
          const sp = d.soldPrice != null ? d.soldPrice : d.listingPrice;
          const profit = (sp != null && d.cost != null) ? sp - d.cost : null;
          const commission = (profit != null) ? profit * 0.15 : null;
          extra = `
            <div><strong>Buying Cost:</strong> ${money(d.cost)}</div>
            <div><strong>Listing Price:</strong> ${money(d.listingPrice)}</div>
            <div><strong>Sold Price:</strong> ${money(sp)}</div>
            <div><strong>Profit:</strong> ${profit != null ? money(profit) : "â€”"}</div>
            <div><strong>Sales Commission (15%):</strong> ${commission != null ? commission.toLocaleString(undefined,{style:"currency",currency:"USD"}) : "â€”"}</div>
            <div><strong>Sold on:</strong> ${d.soldAt.toDate().toLocaleDateString()}</div>`;
        }
        if(d.status === "archive" && d.archivedAt?.toDate){
          extra = `<div><strong>Archived on:</strong> ${d.archivedAt.toDate().toLocaleDateString()} ${d.archiveReason ? "â€” "+d.archiveReason : ""}</div>`;
        }

        card.innerHTML = `
          <h3>${(d.brand||"") + (d.model ? " " + d.model : "")}</h3>
          <div class="meta">Status: ${d.status}${d.year ? " â€¢ Year " + d.year : ""}${d.color ? " â€¢ " + d.color : ""}${d.location ? " â€¢ " + d.location : ""}</div>
          ${d.notes ? `<div class="meta">${d.notes}</div>` : ""}
          ${extra}
          <div class="actions">
            ${currentUser ? `
              ${d.status!=="sold"    ? `<button class="blue"   onclick="updateStatus('${d._id}','sold')">Sell</button>` : ""}
              ${d.status!=="archive" ? `<button class="gray"   onclick="updateStatus('${d._id}','archive')">Archive</button>` : ""}
              ${d.status!=="active"  ? `<button class="green"  onclick="updateStatus('${d._id}','active')">Activate</button>` : ""}
              <button class="orange" onclick='(function(){ window.__setEdit("${d._id}"); })()'>Edit</button>
              <button class="red"    onclick="deletePiano('${d._id}')">Delete</button>
            ` : ""}
          </div>
        `;

        if(d.status === "active")  activeListEl.appendChild(card);
        if(d.status === "sold")    soldListEl.appendChild(card);
        if(d.status === "archive") archiveListEl.appendChild(card);
      }
    }

    // expose an edit helper that pulls fresh doc for safety
    window.__setEdit = async (id)=>{
      const refDoc = doc(db, "pianos", id);
      const snap = await getDoc(refDoc);
      if(snap.exists()){
        setEdit(id, snap.data());
      }
    };

    // ---- Tabs + sorting
    document.querySelectorAll(".tab").forEach(t=>{
      t.onclick = ()=>{
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        currentTab = t.dataset.tab;
        render();
      };
    });
    sortByEl.addEventListener("change", ()=>render());

    // ---- Live Firestore
    onSnapshot(query(collection(db, "pianos"), orderBy("createdAt", "desc")), (snap)=>{
      docsCache = snap.docs.map(d => ({ ...d.data(), _id: d.id }));
      render();
    });

    // ---- Make functions global for inline handlers
    window.updateStatus = updateStatus;
    window.deletePiano = deletePiano;
  </script>
</body>
</html>
